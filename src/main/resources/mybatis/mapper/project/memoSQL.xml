<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="pm">
	<resultMap type="pm" id="pmResult">
		<result property="id" 			column="id"/>
		<result property="fileName" 	column="file_name"/>
		<result property="md5Sign" 		column="md5_sign"/>
		<result property="description" 	column="description"/>
		<result property="projectId"	column="project_id"/>
		<result property="projectName" 	column="project_name"/>
		<result property="createTime" 	column="create_time"/>
		<result property="updateTime" 	column="update_time"/>
	</resultMap>
	
	<select id="queryById" parameterType="int" resultMap="pmResult">
		<![CDATA[
			SELECT
			  pm.`id`,
			  pm.`file_name`,
			  pm.`md5_sign`,
			  pm.`description`,
			  pm.`create_time`,
			  pm.`update_time`,
			  pm.`project_id`,
			  p.`name` AS project_name
			FROM `project_memo` pm LEFT JOIN project p ON pm.`project_id` = p.`id` 
			WHERE pm.`id` = #{id}
		]]>
	</select>
	
	<select id="query" parameterType="java.util.HashMap" resultMap="pmResult">
		<![CDATA[
			SELECT
			  pm.`id`,
			  pm.`file_name`,
			  pm.`md5_sign`,
			  pm.`description`,
			  pm.`create_time`,
			  pm.`update_time`,
			  pm.`project_id`,
			  p.`name` AS project_name
			FROM `project_memo` pm LEFT JOIN project p ON pm.`project_id` = p.`id`
		]]>
		<where>
			<if test="keyword!=null and keyword!=''">
				<![CDATA[
					AND (pm.`file_name` LIKE CONCAT('%',#{keyword},'%')
						OR pm.`md5_sign` LIKE CONCAT('%',#{keyword},'%')
						OR pm.`description` LIKE CONCAT('%',#{keyword},'%')
					)
				]]>
			</if>
			<if test="grant!=null and grant!=''">
				<![CDATA[
					AND pm.`project_id` IN 
				]]>
				<foreach collection="grant" item="item" separator="," open="(" close=")">
					<![CDATA[
						#{item}
					]]>
				</foreach>
			</if>
			<if test="projectId!=null and projectId!=''">
				<![CDATA[
					AND pm.`project_id` = #{projectId}
				]]>
			</if>
			<if test="md5Sign!=null and md5Sign!=''">
				<![CDATA[
					AND pm.md5_sign = #{md5Sign}
				]]>
			</if>
		</where>
		<![CDATA[
			ORDER BY pm.`create_time` DESC
		]]>
		<if test="limit!=null and limit!=''">
			<![CDATA[
				LIMIT #{offset},#{limit}
			]]>
		</if>
	</select>
	
	<select id="count" parameterType="java.util.HashMap" resultType="int">
		<![CDATA[
			SELECT COUNT(pm.id) FROM `project_memo` pm
		]]>
		<where>
			<if test="keyword!=null and keyword!=''">
				<![CDATA[
					AND (pm.`file_name` LIKE CONCAT('%',#{keyword},'%')
						OR pm.`md5_sign` LIKE CONCAT('%',#{keyword},'%')
						OR pm.`description` LIKE CONCAT('%',#{keyword},'%')
					)
				]]>
			</if>
			<if test="grant!=null and grant!=''">
				<![CDATA[
					AND pm.`project_id` IN 
				]]>
				<foreach collection="grant" item="item" separator="," open="(" close=")">
					<![CDATA[
						#{item}
					]]>
				</foreach>
			</if>
			<if test="projectId!=null and projectId!=''">
				<![CDATA[
					AND pm.`project_id` = #{projectId}
				]]>
			</if>
		</where>
	</select>
	
	<update id="update" parameterType="java.util.HashMap">
		<![CDATA[
			UPDATE `project_memo`
			SET
			  `description` = #{description},
			  `update_time` = #{updateTime}
			WHERE `id` = #{id}
		]]>
	</update>
	
	<insert id="insert" parameterType="pm">
		<![CDATA[
			INSERT INTO `project_memo`
            (
             `file_name`,
             `md5_sign`,
             `description`,
             `create_time`,
             `project_id`)
			VALUES (
			        #{fileName},
			        #{md5Sign},
			        #{description},
			        #{createTime},
			        #{projectId})
		]]>
	</insert>
	
	<delete id="delete" parameterType="int">
		<![CDATA[
			DELETE FROM `project_memo` WHERE `id` = #{id}
		]]>
	</delete>
</mapper>  